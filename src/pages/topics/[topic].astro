---
import { getCollection, getEntry } from "astro:content";
import { render } from "astro:content";

import BaseLayout from "../../layouts/Base.astro";
import Header from "../../components/Header.astro";
import BlogListEntry from "../../components/BlogListEntry.astro";

export async function getStaticPaths() {
    const posts = await getCollection("posts");
    const topics = new Set<string>();

    for (const post of posts) {
        for (const topic of post.data.topics ?? []) {
            topics.add(topic.id);
        }
    }

    return await Promise.all(
        Array.from(topics).map(async (topic) => ({
            params: {
                topic,
            },
            props: {
                topic: await getEntry("topics", topic),
                posts: posts.filter((post) => {
                    if (!post.data.topics) {
                        return false;
                    }

                    return post.data.topics.map((topic) => topic.id).includes(topic);
                }),
            },
        })),
    );
}

const { posts, topic } = Astro.props;

if (!topic) {
    return Astro.redirect("/404");
}

const { Content } = await render(topic);

const { label, color: { accent: accentColor, contrast: contrastColor } = {} } = topic.data;
const title = label;
---

<BaseLayout {title}>
    <div class="header with-light-accent-color contents">
        <Header {title}>
            <div class="description contents">
                <Content />
            </div>
        </Header>
    </div>

    <div class="px-4">
        <section class="w-readable mx-auto max-w-full">
            <ul class="divide-y divide-gray-200">
                {
                    posts.map((post) => (
                        <li>
                            <BlogListEntry {post} />
                        </li>
                    ))
                }
            </ul>
        </section>
    </div>
</BaseLayout>

<style define:vars={{ accentColor, contrastColor }}>
    .header {
        --header-background: var(--lightAccentColor);
        --header-border-color: var(--accentColor);
    }

    .description :global(p a) {
        font-weight: 500;
        text-decoration: underline;
    }

    .description :global(ul) {
        list-style: circle;
        margin-left: calc(var(--spacing) * 6);
    }
</style>
