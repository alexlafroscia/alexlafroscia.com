---
import { type CollectionEntry, getCollection } from "astro:content";

import Base from "../../layouts/Base.astro";
import Header from "../../components/Header.astro";
import Topic from "../../components/Topic.astro";
import { getEntry } from "astro:content";

const posts = await getCollection("posts");
const topics = new Map<CollectionEntry<"topics">, number>();

for (const post of posts) {
    for (const topic of post.data.topics ?? []) {
        const topicEntry = await getEntry(topic);
        const currentCount = topics.get(topicEntry) ?? 0;

        topics.set(topicEntry, currentCount + 1);
    }
}

const title = "Topics";
---

<Base {title}>
    <Header {title} />

    <div class="px-2">
        <section class="w-readable mx-auto max-w-full">
            <ul class="flex flex-wrap gap-3">
                {
                    Array.from(topics.entries())
                        .toSorted(([_aTopic, aCount], [_bTopic, bCount]) => bCount - aCount)
                        .map(([topic, count]) => (
                            <li>
                                <Topic {topic}>
                                    {topic} ({count})
                                </Topic>
                            </li>
                        ))
                }
            </ul>
        </section>
    </div>
</Base>
