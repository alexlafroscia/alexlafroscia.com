---
import { getCollection } from "astro:content";

import Index, { type BlogPostIndex } from "../layouts/BlogPostIndex.astro";
import { generateSlugs } from "../utils/path";

export async function getStaticPaths() {
    const posts = await getCollection("posts");
    const map = new Map<string, BlogPostIndex>();

    for (const post of posts) {
        const slugs = generateSlugs(post.id)
            // Remove the last slug, as it represents an actual post
            .slice(0, -1)
            // We don't need the labels; just the URL patterns
            .map((slug) => slug.path);

        for (const slug of slugs) {
            const blogPostIndex = map.get(slug) ?? [];

            blogPostIndex.push(post);

            map.set(slug, blogPostIndex);
        }
    }

    return Array.from(map.entries()).map(([indexPath, posts]) => {
        posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

        return {
            params: {
                indexPath,
            },
            props: {
                posts,
                indexPath,
            },
        };
    });
}

const { posts, indexPath } = Astro.props;

const title =
    Astro.url.pathname
        .replace(import.meta.env.BASE_URL, "")
        .split("/")
        .at(-1) ?? "";

const description = `All posts under ${indexPath}`;
---

<Index {title} {description} {posts} />
